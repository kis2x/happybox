name: Create rust vendor tarball

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  dodeps:
    runs-on: ubuntu-latest
    env:
      REPOS: |
        ouch-org/ouch
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install GitHub CLI
        run: |
          type -p wget >/dev/null || (sudo apt update && sudo apt-get install wget -y)
          sudo mkdir -p -m 755 /etc/apt/keyrings
          wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null
          sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Create tarball
        shell: bash
        run: |
          # Read repos into an array
          mapfile -t repos < <(echo "$REPOS" | tr -d '\r')

          for repo in "${repos[@]}"; do
            if [ -z "$repo" ]; then continue; fi
            basename=$(basename "$repo")
            echo "Checking releases for $repo"

            # Get latest release tag
            tag=$(gh api --paginate "repos/$repo/releases" --jq '.[].tag_name' | head -n1)
            release_name="${basename}-${tag}"
            tarball="${basename}-${tag}-deps.tar.xz"
            
            # Check if release already exists in this repo
            if gh release view "$release_name" >/dev/null 2>&1; then
              echo "Tarball for $release_name already exists, skipping."
              continue
            fi
            
            echo "Processing new release: $tag for $repo"
            # Clone the repo at the latest tag
            git clone --depth 1 --branch "$tag" "https://github.com/$repo.git" temp_dir
            cd temp_dir

            # Download deps
            cargo vendor --versioned-dirs cargo_home/gentoo/

            # Create tarball
            XZ_OPT='-T0 -9' tar -acf "../$tarball" cargo_home/
            cd ..

            # Create release
            gh release create "$release_name" \
              --title "$release_name" \
              --notes "Vendored dependencies for $release_name" \
              "$tarball"

            # Clean up
            rm -rf temp_dir "$tarball"
          done
