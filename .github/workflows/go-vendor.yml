name: Create go vendor tarball

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  
jobs:
  dodeps:
    runs-on: ubuntu-latest
    env:
      REPOS: |
        babarot/gomi
        charmbracelet/gum
        charmbracelet/soft-serve
        pomdtr/sunbeam
        savedra1/clipse
        joshmedeski/sesh
        kubernetes/minikube
        kubernetes-sigs/kind
        bloznelis/typioca
        go-task/task
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Install GitHub CLI
        run: |
          type -p wget >/dev/null || (sudo apt update && sudo apt-get install wget -y)
          sudo mkdir -p -m 755 /etc/apt/keyrings
          wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null
          sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Create tarball
        shell: bash
        run: |
          # Read repos into an array
          mapfile -t repos < <(echo "$REPOS" | tr -d '\r')

          for repo in "${repos[@]}"; do
            if [ -z "$repo" ]; then continue; fi
            basename=$(basename "$repo")
            echo "Checking releases for $repo"

            # Get latest release tag
            latest_tag=$(gh api "repos/$repo/releases/latest" --jq '.tag_name' 2>/dev/null || echo "")
            tag=$(echo $latest_tag | sed 's/^v//')
            release_name="${basename}-${tag}"
            tarball="${basename}-${tag}-deps.tar.xz"
            
            # Check if release already exists in this repo
            if gh release view "$release_name" >/dev/null 2>&1; then
              echo "Tarball for $release_name already exists, skipping."
              continue
            fi
            
            echo "Processing new release: $tag for $repo"
            # Clone the repo at the latest tag
            git clone --depth 1 --branch "$latest_tag" "https://github.com/$repo.git" temp_dir
            cd temp_dir

            # Download deps
            GOMODCACHE="${PWD}"/go-mod go mod download -modcacherw

            # Create tarball
            XZ_OPT='-T0 -9' tar -acf "../$tarball" go-mod/
            cd ..

            # Create release
            gh release create "$release_name" \
              --title "$release_name" \
              --notes "Vendored dependencies for $release_name" \
              "$tarball"

            # Clean up
            rm -rf temp_dir "$tarball"
          done
